<html>
  <head>
    <title>Music visualization</title>
    <script src="https://d3js.org/d3.v7.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
  </head>

  <body class="main">
    <div style="display: flex; flex-direction: column">
      <div style="display: flex; height: calc(70vh - 30px)">
        <div class="view" style="width: 20vw"></div>
        <div class="view" style="width: 80vw"></div>
      </div>
      <div
        class="view"
        id="svg"
        style="height: 30vh; width: calc(100vw - 30px); overflow-x: scroll"
      ></div>
    </div>

    <script>
      // load a midi file in the browser
      let margin = { top: 0, right: 40, bottom: 0, left: 0 };
      // let svg_size = Math.max(
      //   document.documentElement.clientWidth - margin.left - margin.right - 20,
      //   document.documentElement.clientHeight * 0.3
      // );
      let vp = {
        width:
          document.documentElement.clientWidth -
          margin.left -
          margin.right -
          20,
        height: document.documentElement.clientHeight * 0.3 - 30,
      };
      let data = [];
      let names = [
        "alb_esp1.mid",
        "alb_esp2.mid",
        "alb_esp3.mid",
        "alb_esp4.mid",
        "alb_esp5.mid",
        "alb_esp6.mid",
        "alb_se1.mid",
        "alb_se2.mid",
        "alb_se3.mid",
        "alb_se4.mid",
        "alb_se5.mid",
        "alb_se6.mid",
        "alb_se7.mid",
        "alb_se8.mid",
        "alb_se9.mid",
      ];
      let x, y;
      let svg_density = define_svg("#svg");
      let color = {
        "Piano right": "#a6cee3",
        "Piano left": "#1f78b4",
        "1er Piano 1": "#a6cee3",
        "1er Piano 2": "#1f78b4",
        "2d Piano 1": "#b1d5c8",
        "2d Piano 2": "#80a492",
        Violoncelle: "#ffee6f",
      };
      load_data(names[0]);

      async function load_data(name) {
        data = await Midi.fromUrl("../data/albeniz/" + name);
        console.log(data);

        //the file name decoded from the first track
        // const name = midi.name;
        // //get the tracks
        // midi.tracks.forEach((track) => {
        //   //tracks have notes and controlChanges
        //   //notes are an array
        //   const notes = track.notes;
        //   notes.forEach((note) => {
        //     //note.midi, note.time, note.duration, note.name
        //   });

        //   //the control changes are an object
        //   //the keys are the CC number
        //   track.controlChanges[64];
        //   //they are also aliased to the CC number's common name (if it has one)
        //   track.controlChanges.sustain.forEach((cc) => {
        //     // cc.ticks, cc.value, cc.time
        //   });

        //   //the track also has a channel and instrument
        //   //track.instrument.name
        // }
        // );
        for (let index = 0; index < 20; index++) {
          if (data.tracks[index] == undefined) break;
          if (data.tracks[index].notes.length != 0)
            render(data.tracks[index].notes, index);
        }
      }
      /**
       * add a svg to the given place
       * @param [selector] a string represent a class/id/tag
       * @return the svg object
       */
      function define_svg(selector) {
        let svg = d3
          .select(selector)
          .append("svg")
          .attr("width", 5 * (vp.width + margin.left + margin.right))
          .attr("height", vp.height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.right + "," + 0 + ")");
        return svg;
      }
      function render(ddata, index) {
        var x = d3
          .scaleLinear()
          .domain([0, 260])
          .range([0, vp.width * 5]);

        var y = d3.scaleLinear().domain([0, 1]).range([0, 50]);

        let midi = d3.scaleLinear().domain([0, 120]).range([0, vp.height]);
        let area = d3
          .area()
          .x(function (d) {
            return x(d.time);
          })
          .y0(function (d) {
            return midi(d.midi);
          })
          .y1(function (d) {
            return midi(d.midi) + y(d.velocity);
          })

          .curve(d3.curveBasis);
        svg_density
          .selectAll("#Selector")
          .data([ddata])
          .join("path")
          .attr("fill", color[data.tracks[index].name])
          // .attr("stroke", color[index])
          .attr("d", (d) => area(d));
      }
    </script>
    <style>
      .view {
        border-radius: 17px;
        box-shadow: 2px 2px 3px #beb1aa;
        margin: 5px;
        background-color: #f5f2e9;
      }
      .main {
        background-color: #c7c6b6;
      }
    </style>
  </body>
</html>
